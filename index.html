<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keberadaan Guru - SK Bukit Cermin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        
        .nav-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0 2px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .percentage-excellent { 
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        
        .percentage-good { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .percentage-warning { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        
        .percentage-danger { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slideInRight { animation: slideInRight 0.6s ease-out; }
        .animate-fadeInUp { animation: fadeInUp 0.6s ease-out; }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        

    </style>
</head>
<body class="min-h-full gradient-bg">
    <!-- Header -->
    <header class="glass-card border-b border-white/20">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-xl">
                        <span class="text-white font-bold text-2xl">üè´</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">SISTEM KEBERADAAN GURU</h1>
                        <h2 class="text-3xl font-bold text-white">SK BUKIT CERMIN</h2>
                        <p class="text-blue-200 text-sm">HAK MILIK :2025@ZAMBRIE BIN MOHAMMED</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-white text-lg font-medium" id="currentDate"></p>
                        <p class="text-blue-200 text-sm">Hak Milik: ZAMBRIE BIN MOHAMMED</p>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div id="connectionIndicator" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="connectionText" class="text-white text-sm">Offline</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Header -->
    <nav class="glass-card border-b border-white/20 mt-2">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Navigation Menu -->
                <div class="flex items-center space-x-1">
                    <div class="nav-item active px-4 py-2 cursor-pointer rounded-lg" data-section="dashboard">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl">üìä</span>
                            <span class="text-white font-medium">Dashboard</span>
                        </div>
                    </div>
                    
                    <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-section="administration">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <span class="text-white font-medium">Pentadbiran</span>
                        </div>
                    </div>
                    
                    <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-section="attendance">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl">‚úÖ</span>
                            <span class="text-white font-medium">Kehadiran</span>
                        </div>
                    </div>
                    
                    <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-section="reports">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl">üìà</span>
                            <span class="text-white font-medium">Pelaporan</span>
                        </div>
                    </div>
                    
                    <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-section="analytics">
                        <div class="flex items-center space-x-2">
                            <span class="text-xl">üîç</span>
                            <span class="text-white font-medium">Analisis</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="text-center">
                            <div class="text-blue-200">Guru</div>
                            <div class="text-white font-bold" id="headerTotalTeachers">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-blue-200">Hari Ini</div>
                            <div class="text-white font-bold" id="headerTodayAttendance">0%</div>
                        </div>
                        <div class="text-center">
                            <div class="text-blue-200">Purata</div>
                            <div class="text-white font-bold" id="headerMonthlyAverage">0%</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div id="connectionIndicator" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="connectionText" class="text-white text-sm">Offline</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-8">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section-content">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Dashboard Keberadaan Guru</h2>
                    <p class="text-blue-200">Paparan keseluruhan prestasi kehadiran guru SK Bukit Cermin</p>
                </div>

                <!-- Main Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-card rounded-2xl p-6 card-hover animate-fadeInUp">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-blue-200 text-sm font-medium">Jumlah Guru</div>
                                <div class="text-white text-3xl font-bold" id="dashTotalTeachers">0</div>
                                <div class="text-green-400 text-sm" id="dashTeacherChange">Semua guru</div>
                            </div>
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                <span class="text-white text-2xl">üë•</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 0.05s">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-blue-200 text-sm font-medium">Hari Sekolah</div>
                                <div class="text-white text-3xl font-bold" id="dashSchoolDays">0</div>
                                <div class="text-purple-400 text-sm" id="dashSchoolDaysLabel">bulan ini</div>
                            </div>
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                                <span class="text-white text-2xl">üìÖ</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 0.1s">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-blue-200 text-sm font-medium">Kehadiran Hari Ini</div>
                                <div class="text-white text-3xl font-bold" id="dashTodayAttendance">0%</div>
                                <div class="text-green-400 text-sm" id="dashTodayChange">+0% dari semalam</div>
                            </div>
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center">
                                <span class="text-white text-2xl">‚úÖ</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 0.15s">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-blue-200 text-sm font-medium">Purata Bulanan</div>
                                <div class="text-white text-3xl font-bold" id="dashMonthlyAverage">0%</div>
                                <div class="text-yellow-400 text-sm" id="dashMonthlyChange">+0% dari bulan lalu</div>
                            </div>
                            <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl flex items-center justify-center">
                                <span class="text-white text-2xl">üìä</span>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.4s">
                        <h3 class="text-xl font-bold text-white mb-4">Trend Kehadiran Bulanan</h3>
                        <div class="chart-container">
                            <canvas id="dashboardMonthlyChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.5s">
                        <h3 class="text-xl font-bold text-white mb-4">Kategori Ketidakhadiran</h3>
                        <div class="chart-container">
                            <canvas id="dashboardCategoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity & Top Performers -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.6s">
                        <h3 class="text-xl font-bold text-white mb-4">Aktiviti Terkini</h3>
                        <div id="recentActivity" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-blue-200 text-center py-8">Tiada aktiviti terkini</p>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.7s">
                        <h3 class="text-xl font-bold text-white mb-4">Prestasi Terbaik Bulan Ini</h3>
                        <div id="topPerformers" class="space-y-3">
                            <p class="text-blue-200 text-center py-8">Tiada data prestasi</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administration Section -->
            <div id="administrationSection" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Pentadbiran Sistem</h2>
                    <p class="text-blue-200">Pengurusan sambungan cloud dan tetapan sistem</p>
                </div>

                <!-- Cloud Connection -->
                <div class="glass-card rounded-2xl p-6 animate-slideInRight mb-8">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <span class="mr-3">‚òÅÔ∏è</span> Sambungan Cloud
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="googleSheetUrl" class="block text-sm font-medium text-blue-200 mb-2">URL Google Apps Script</label>
                                <input type="url" id="googleSheetUrl" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="https://script.google.com/macros/s/...">
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="connectBtn" class="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 px-4 rounded-lg font-medium hover:from-purple-600 hover:to-purple-700 transition-all duration-300">
                                    üîó Sambung ke Google Sheets
                                </button>
                                <button id="testConnectionBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-600 hover:to-blue-700 transition-all duration-300">
                                    üß™ Uji
                                </button>
                            </div>
                            
                            <div class="bg-white/5 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-blue-200">Status Sambungan:</span>
                                    <div id="connectionStatus" class="flex items-center space-x-2">
                                        <div id="connectionStatusIndicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                                        <span id="connectionStatusText" class="text-red-300 text-sm">Tidak Disambung</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sync Status -->
                        <div class="mt-6">
                            <h4 class="text-white font-medium mb-3">Status Sync Terakhir</h4>
                            <div id="lastSyncStatus" class="bg-white/5 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-blue-200">Sync Terakhir:</span>
                                    <span id="lastSyncTime" class="text-white">Belum ada sync</span>
                                </div>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-blue-200">Status:</span>
                                    <span id="lastSyncResult" class="text-gray-400">Menunggu data</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Apps Script Code -->
                        <div class="mt-6">
                            <h4 class="text-white font-medium mb-3">Kod Apps Script</h4>
                            <div class="bg-gray-900 rounded-lg p-4 text-xs font-mono text-green-400 max-h-60 overflow-y-auto">
                                <pre>function doPost(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getActiveSheet();
    
    if (e && e.parameter) {
      var teacher = e.parameter.teacher || '';
      var date = e.parameter.date || '';
      var status = e.parameter.status || '';
      var reason = e.parameter.reason || '';
      var timestamp = new Date().toISOString();
      
      sheet.appendRow([teacher, date, status, reason, timestamp]);
    }
    
    return ContentService.createTextOutput('success');
  } catch (error) {
    return ContentService.createTextOutput('error: ' + error.toString());
  }
}

function doGet(e) {
  return ContentService.createTextOutput('success');
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Pengurusan Kehadiran</h2>
                    <p class="text-blue-200">Input dan pengurusan kehadiran harian guru</p>
                </div>

                <!-- Teacher Management -->
                <div class="glass-card rounded-2xl p-6 mb-8 animate-fadeInUp">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <span class="mr-3">üë•</span> Pengurusan Guru
                    </h3>
                    
                    <!-- Add Teacher Form -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-xl border border-green-400/30">
                        <h4 class="text-white font-medium mb-4 flex items-center">
                            <span class="mr-2">‚ûï</span> Tambah Guru Baru
                        </h4>
                        
                        <form id="teacherForm" class="space-y-4">
                            <div>
                                <label for="teacherName" class="block text-sm font-medium text-green-200 mb-2">Nama Penuh Guru</label>
                                <input type="text" id="teacherName" class="w-full px-4 py-3 bg-white/10 border border-green-400/30 rounded-lg text-white placeholder-green-200 focus:ring-2 focus:ring-green-400 focus:border-transparent transition-all duration-300" placeholder="Cth: Puan Siti Aminah binti Ahmad" required>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" id="addTeacherBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-3 rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                    ‚ûï Tambah Guru
                                </button>
                                
                                <button type="button" id="clearFormBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
                                    üóëÔ∏è Kosongkan
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Teachers Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500/20 to-blue-600/20 rounded-lg p-4 border border-blue-400/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-blue-200 text-sm">Jumlah Guru</div>
                                    <div class="text-white text-2xl font-bold" id="totalTeachersCount">0</div>
                                </div>
                                <span class="text-3xl">üë•</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500/20 to-purple-600/20 rounded-lg p-4 border border-purple-400/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-purple-200 text-sm">Guru Aktif</div>
                                    <div class="text-white text-2xl font-bold" id="activeTeachersCount">0</div>
                                </div>
                                <span class="text-3xl">‚úÖ</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-500/20 to-yellow-600/20 rounded-lg p-4 border border-yellow-400/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-yellow-200 text-sm">Kehadiran Purata</div>
                                    <div class="text-white text-2xl font-bold" id="averageAttendanceRate">0%</div>
                                </div>
                                <span class="text-3xl">üìä</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-indigo-500/20 to-indigo-600/20 rounded-lg p-4 border border-indigo-400/30">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-indigo-200 text-sm">Hari Sekolah</div>
                                    <div class="text-white text-2xl font-bold" id="adminSchoolDays">0</div>
                                </div>
                                <span class="text-3xl">üìÖ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Kehadiran Harian -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-500/20 to-indigo-500/20 rounded-xl border border-blue-400/30">
                        <h4 class="text-white font-medium mb-4 flex items-center">
                            <span class="mr-2">üìù</span> Input Kehadiran Harian
                        </h4>
                        
                        <form id="attendanceForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="selectedTeacher" class="block text-sm font-medium text-blue-200 mb-2">Pilih Guru</label>
                                <select id="selectedTeacher" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-400" required>
                                    <option value="">-- Pilih Guru --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="attendanceDate" class="block text-sm font-medium text-blue-200 mb-2">Tarikh</label>
                                <input type="date" id="attendanceDate" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-400" required>
                            </div>
                            
                            <div>
                                <label for="absentReason" class="block text-sm font-medium text-blue-200 mb-2">Sebab (jika tidak hadir)</label>
                                <select id="absentReason" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-red-400">
                                    <option value="">-- Pilih Sebab --</option>
                                    <optgroup label="DIKIRA HADIR (TIDAK TOLAK PERATUS)">
                                        <option value="BEKERJA_DARI_RUMAH">BEKERJA DARI RUMAH</option>
                                        <option value="BENGKEL">BENGKEL</option>
                                        <option value="BERTUGAS_KOKURIKULUM">BERTUGAS DALAM KOKURIKULUM/KOAKADEMIK/SUKAN</option>
                                        <option value="COVID19">COVID-19</option>
                                        <option value="KURSUS">KURSUS</option>
                                        <option value="MESYUARAT">MESYUARAT</option>
                                        <option value="PENGAWAS_PEPERIKSAAN">PENGAWAS PEPERIKSAAN</option>
                                        <option value="PROSES_PEMULIHAN_JPN">PROSES PEMULIHAN DI JPN</option>
                                        <option value="PROSES_PEMULIHAN_PPD">PROSES PEMULIHAN DI PPD</option>
                                        <option value="TAKLIMAT">TAKLIMAT</option>
                                        <option value="TUGAS_RASMI">TUGAS RASMI SEPERTI YANG DIARAHKAN OLEH PENTADBIRAN SEKOLAH/PPD/JPN/KPM</option>
                                        <option value="CUTI_TANPA_REKOD">CUTI TANPA REKOD</option>
                                    </optgroup>
                                    <optgroup label="DIKIRA TIDAK HADIR (TOLAK PERATUS)">
                                        <option value="CUTI_BERSALIN">CUTI BERSALIN</option>
                                        <option value="CUTI_HAJI">CUTI HAJI</option>
                                        <option value="CUTI_KECEDERAAN">CUTI KECEDERAAN</option>
                                        <option value="CUTI_KECEMASAN_AM">CUTI KECEMASAN AM</option>
                                        <option value="CUTI_KUARANTIN">CUTI KUARANTIN</option>
                                        <option value="CUTI_KURSUS_SAMBILAN">CUTI KURSUS SAMBILAN (PJJ)</option>
                                        <option value="CUTI_KURSUS_BELAJAR">CUTI KURSUS/BELAJAR</option>
                                        <option value="CUTI_MENJAGA_ANAK">CUTI MENJAGA ANAK (CUTI TANPA GAJI)</option>
                                        <option value="CUTI_REHAT">CUTI REHAT</option>
                                        <option value="CUTI_REHAT_KHAS">CUTI REHAT KHAS</option>
                                        <option value="CUTI_SAKIT">CUTI SAKIT</option>
                                        <option value="CUTI_SAKIT_LANJUTAN">CUTI SAKIT LANJUTAN</option>
                                        <option value="CUTI_TANPA_GAJI">CUTI TANPA GAJI</option>
                                        <option value="CUTI_SEPARUH_GAJI">CUTI SEPARUH GAJI</option>
                                        <option value="CUTI_TANPA_GAJI_IKUT_PASANGAN">CUTI TANPA GAJI IKUT PASANGAN</option>
                                        <option value="CUTI_TIBI_KUSTA_BARAH">CUTI TIBI/KUSTA/BARAH</option>
                                        <option value="CUTI_UMRAH">CUTI UMRAH</option>
                                        <option value="TAHAN_GANTUNG_KERJA">TAHAN/GANTUNG KERJA (TATATERTIB)</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2 lg:col-span-3">
                                <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-8 rounded-lg font-medium hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                    üíæ Simpan Kehadiran
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- School Days Management -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-indigo-500/20 to-purple-500/20 rounded-xl border border-indigo-400/30">
                        <h4 class="text-white font-medium mb-4 flex items-center">
                            <span class="mr-2">üìÖ</span> Tetapan Hari Sekolah
                        </h4>
                        
                        <form id="schoolDaysForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="schoolDaysMonth" class="block text-sm font-medium text-indigo-200 mb-2">Bulan</label>
                                <select id="schoolDaysMonth" class="w-full px-4 py-3 bg-green-600 border border-indigo-400/30 rounded-lg text-white focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition-all duration-300">
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Mac</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Julai</option>
                                    <option value="8">Ogos</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Disember</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="schoolDaysYear" class="block text-sm font-medium text-indigo-200 mb-2">Tahun</label>
                                <select id="schoolDaysYear" class="w-full px-4 py-3 bg-green-600 border border-indigo-400/30 rounded-lg text-white focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition-all duration-300">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="schoolDaysCount" class="block text-sm font-medium text-indigo-200 mb-2">Bilangan Hari Sekolah</label>
                                <input type="number" id="schoolDaysCount" min="1" max="31" class="w-full px-4 py-3 bg-white/10 border border-indigo-400/30 rounded-lg text-white placeholder-indigo-200 focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition-all duration-300" placeholder="Auto dikira...">
                                <div class="text-xs text-indigo-300 mt-1">Sistem auto kira hari bekerja. Tolak jika ada cuti tambahan.</div>
                            </div>
                            
                            <div class="md:col-span-3">
                                <button type="submit" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-8 py-3 rounded-lg font-medium hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                    üíæ Simpan Hari Sekolah
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Teachers List -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-white font-medium text-lg">Senarai Guru Terdaftar</h4>
                            <div class="flex space-x-2">
                                <input type="text" id="searchTeacher" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 text-sm focus:ring-2 focus:ring-blue-400" placeholder="üîç Cari guru...">
                                <button id="exportTeachersBtn" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300">
                                    üìÑ Eksport
                                </button>
                            </div>
                        </div>
                        
                        <div id="teachersList" class="bg-white/5 rounded-lg p-4 max-h-80 overflow-y-auto">
                            <p class="text-blue-300 text-sm italic text-center py-8">Tiada guru didaftarkan</p>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Today's Attendance Overview -->
                <div class="glass-card rounded-2xl p-6 mt-8 animate-fadeInUp" style="animation-delay: 0.2s">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <span class="mr-3">üìÖ</span> Kehadiran Hari Ini
                    </h3>
                    
                    <div id="todayAttendanceOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-blue-200 text-center py-8 md:col-span-2 lg:col-span-3">Tiada data kehadiran hari ini</p>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Pelaporan & Statistik</h2>
                    <p class="text-blue-200">Laporan komprehensif kehadiran guru mengikut tempoh</p>
                </div>

                <!-- Report Filters -->
                <div class="glass-card rounded-2xl p-6 mb-8 animate-fadeInUp">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <span class="mr-3">üîç</span> Penapis Laporan
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="reportType" class="block text-sm font-medium text-blue-200 mb-2">Jenis Laporan</label>
                            <select id="reportType" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-400">
                                <option value="monthly">Bulanan</option>
                                <option value="yearly">Tahunan</option>
                                <option value="custom">Tempoh Tersuai</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="reportMonth" class="block text-sm font-medium text-blue-200 mb-2">Bulan</label>
                            <select id="reportMonth" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-400">
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Mac</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Jun</option>
                                <option value="7">Julai</option>
                                <option value="8">Ogos</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Disember</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="reportYear" class="block text-sm font-medium text-blue-200 mb-2">Tahun</label>
                            <select id="reportYear" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-400">
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end">
                            <button id="generateReportBtn" class="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-3 px-4 rounded-lg font-medium hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300">
                                üìä Jana Laporan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Individual Performance Report -->
                <div class="glass-card rounded-2xl p-6 mb-8 animate-fadeInUp" style="animation-delay: 0.2s">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                        <span class="mr-3">üë§</span> Prestasi Individu Guru
                    </h3>
                    
                    <div id="individualPerformanceReport" class="space-y-4">
                        <p class="text-blue-200 text-center py-8">Sila jana laporan untuk melihat prestasi individu</p>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.3s">
                        <h3 class="text-xl font-bold text-white mb-4">üìà Statistik Keseluruhan</h3>
                        <div id="summaryStats" class="space-y-4">
                            <p class="text-blue-200 text-center py-8">Tiada statistik untuk dipaparkan</p>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.4s">
                        <h3 class="text-xl font-bold text-white mb-4">üèÜ Guru Terbaik</h3>
                        <div id="topPerformersReport" class="space-y-3">
                            <p class="text-blue-200 text-center py-8">Tiada data prestasi</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Analisis Mendalam</h2>
                    <p class="text-blue-200">Analisis trend, perbandingan dan ramalan kehadiran guru</p>
                </div>

                <!-- Analytics Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp">
                        <h3 class="text-xl font-bold text-white mb-4">üìä Trend Kehadiran 12 Bulan</h3>
                        <div class="chart-container">
                            <canvas id="yearlyTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.1s">
                        <h3 class="text-xl font-bold text-white mb-4">üìà Perbandingan Bulanan</h3>
                        <div class="chart-container">
                            <canvas id="monthlyComparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analytics -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.2s">
                        <h3 class="text-xl font-bold text-white mb-4">üîç Analisis Kategori</h3>
                        <div id="categoryAnalysis" class="space-y-3">
                            <p class="text-blue-200 text-center py-8">Tiada data untuk analisis</p>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.3s">
                        <h3 class="text-xl font-bold text-white mb-4">üìÖ Analisis Hari</h3>
                        <div id="dayAnalysis" class="space-y-3">
                            <p class="text-blue-200 text-center py-8">Tiada data untuk analisis</p>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 animate-fadeInUp" style="animation-delay: 0.4s">
                        <h3 class="text-xl font-bold text-white mb-4">üéØ Ramalan Trend</h3>
                        <div id="trendPrediction" class="space-y-3">
                            <p class="text-blue-200 text-center py-8">Tiada data untuk ramalan</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>



    <!-- Messages -->
    <div id="messageArea" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let isConnected = false;
        let teachers = JSON.parse(localStorage.getItem('sk_bukit_cermin_teachers')) || [];
        let teachersDetails = JSON.parse(localStorage.getItem('sk_bukit_cermin_teachers_details')) || [];
        let attendanceData = JSON.parse(localStorage.getItem('sk_bukit_cermin_attendance')) || [];
        let googleSheetUrl = localStorage.getItem('sk_bukit_cermin_sheet_url') || '';
        let schoolDays = JSON.parse(localStorage.getItem('sk_bukit_cermin_school_days')) || {};

        // Chart instances
        let dashboardMonthlyChart, dashboardCategoryChart, yearlyTrendChart, monthlyComparisonChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000);
            
            if (googleSheetUrl) {
                document.getElementById('googleSheetUrl').value = googleSheetUrl;
                checkConnection();
            }
            
            updateAllData();
            setupEventListeners();
            setTodayDate();
            setCurrentMonth();
            
            // Force update dropdown after a short delay to ensure DOM is ready
            setTimeout(() => {
                updateTeachersDropdown();
                updateSchoolDaysInput(); // Auto calculate school days on load
                console.log('Initial teachers list:', teachers);
            }, 100);
        });

        // Utility functions
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Kuala_Lumpur'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ms-MY', options);
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
        }

        function setCurrentMonth() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            document.getElementById('reportMonth').value = currentMonth;
            document.getElementById('reportYear').value = currentYear;
            
            // Set school days form to current month/year
            if (document.getElementById('schoolDaysMonth')) {
                document.getElementById('schoolDaysMonth').value = currentMonth;
                document.getElementById('schoolDaysYear').value = currentYear;
            }
        }

        // School days management functions
        function saveSchoolDays() {
            const month = parseInt(document.getElementById('schoolDaysMonth').value);
            const year = parseInt(document.getElementById('schoolDaysYear').value);
            const days = parseInt(document.getElementById('schoolDaysCount').value);
            
            if (!days || days < 1 || days > 31) {
                showMessage('error', 'Sila masukkan bilangan hari yang sah (1-31).');
                return;
            }

            const key = `${year}-${month}`;
            schoolDays[key] = days;
            localStorage.setItem('sk_bukit_cermin_school_days', JSON.stringify(schoolDays));
            
            updateAllData();
            document.getElementById('schoolDaysForm').reset();
            setCurrentMonth(); // Reset to current month
            
            const monthNames = ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 
                              'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            showMessage('success', `Hari sekolah untuk ${monthNames[month]} ${year} telah ditetapkan kepada ${days} hari.`);
        }

        function autoCalculateSchoolDays(month, year) {
            // Calculate weekdays in the month (excluding weekends)
            const daysInMonth = new Date(year, month, 0).getDate();
            let schoolDaysCount = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                
                // Count Monday to Friday (1-5), exclude Saturday (6) and Sunday (0)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    schoolDaysCount++;
                }
            }
            
            return schoolDaysCount;
        }

        function updateSchoolDaysInput() {
            const month = parseInt(document.getElementById('schoolDaysMonth').value);
            const year = parseInt(document.getElementById('schoolDaysYear').value);
            
            // Check if there's already a saved value for this month/year
            const key = `${year}-${month}`;
            const savedDays = schoolDays[key];
            
            if (savedDays) {
                // Use saved value
                document.getElementById('schoolDaysCount').value = savedDays;
            } else {
                // Auto calculate and show in input
                const calculatedDays = autoCalculateSchoolDays(month, year);
                document.getElementById('schoolDaysCount').value = calculatedDays;
            }
        }

        function showMessage(type, message) {
            const messageEl = document.createElement('div');
            messageEl.className = `p-4 rounded-lg shadow-2xl transform transition-all duration-300 ${
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600' : 
                type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : 
                'bg-gradient-to-r from-blue-500 to-blue-600'
            } text-white`;
            messageEl.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-3 text-xl">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.getElementById('messageArea').appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.transform = 'translateX(100%)';
                setTimeout(() => messageEl.remove(), 300);
            }, 4000);
        }

        // Section switching
        function switchSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Add active class to selected nav item
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            
            currentSection = sectionName;
            
            // Update section-specific data
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'attendance') {
                updateTodayAttendanceOverview();
            }
        }

        // Connection management
        async function checkConnection() {
            if (!googleSheetUrl) return false;

            try {
                // Test with a simple GET request first
                const response = await fetch(googleSheetUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                // For no-cors mode, we can't check response status, so assume success
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.log('Connection test failed:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            // Update header connection status
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            // Update administration section connection status
            const adminIndicator = document.getElementById('connectionStatusIndicator');
            const adminText = document.getElementById('connectionStatusText');
            
            if (connected) {
                // Header status
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                }
                if (text) {
                    text.textContent = 'Online';
                    text.className = 'text-green-300 text-sm font-medium';
                }
                
                // Admin section status
                if (adminIndicator) {
                    adminIndicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                }
                if (adminText) {
                    adminText.textContent = 'Bersambung';
                    adminText.className = 'text-green-300 text-sm font-medium';
                }
                
                isConnected = true;
            } else {
                // Header status
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                }
                if (text) {
                    text.textContent = 'Offline';
                    text.className = 'text-red-300 text-sm';
                }
                
                // Admin section status
                if (adminIndicator) {
                    adminIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                }
                if (adminText) {
                    adminText.textContent = 'Tidak Disambung';
                    adminText.className = 'text-red-300 text-sm';
                }
                
                isConnected = false;
            }
        }

        // Data management functions
        function updateAllData() {
            updateHeaderStats();
            updateTeachersList();
            updateTeachersDropdown();
            updateDashboard();
        }

        function updateHeaderStats() {
            document.getElementById('headerTotalTeachers').textContent = teachers.length;
            
            // Calculate today's attendance
            const today = new Date().toISOString().split('T')[0];
            const todayData = attendanceData.filter(record => record.date === today);
            
            // Reasons that are counted as PRESENT (not deducted from percentage)
            const countAsPresent = [
                'BEKERJA_DARI_RUMAH',
                'BENGKEL', 
                'BERTUGAS_KOKURIKULUM',
                'COVID19',
                'KURSUS',
                'MESYUARAT',
                'PENGAWAS_PEPERIKSAAN',
                'PROSES_PEMULIHAN_JPN',
                'PROSES_PEMULIHAN_PPD',
                'TAKLIMAT',
                'TUGAS_RASMI',
                'CUTI_TANPA_REKOD'
            ];
            
            let todayPercentage = 0;
            if (teachers.length > 0) {
                if (todayData.length === 0) {
                    // No attendance data for today - show 100% (assume all present if no records)
                    todayPercentage = 100;
                } else {
                    // Calculate percentage based on all teachers
                    let presentCount = 0;
                    
                    teachers.forEach(teacher => {
                        const teacherRecord = todayData.find(r => r.teacher === teacher);
                        
                        if (!teacherRecord) {
                            // No record for this teacher - assume present
                            presentCount++;
                        } else if (teacherRecord.status === 'HADIR') {
                            // Marked as present
                            presentCount++;
                        } else if (teacherRecord.status === 'TIDAK_HADIR' && countAsPresent.includes(teacherRecord.reason)) {
                            // Absent but with reason that counts as present
                            presentCount++;
                        }
                        // Other absent reasons reduce the count
                    });
                    
                    todayPercentage = (presentCount / teachers.length) * 100;
                }
            }
            document.getElementById('headerTodayAttendance').textContent = Math.round(todayPercentage) + '%';
            
            // Calculate monthly average
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthlyData = filterDataByPeriod(attendanceData, 'monthly', currentMonth, currentYear);
            const monthlyPercentages = calculateAttendancePercentages(monthlyData, 'monthly', currentMonth, currentYear);
            const monthlyAverage = monthlyPercentages.length > 0 ? 
                monthlyPercentages.reduce((sum, p) => sum + p.percentage, 0) / monthlyPercentages.length : 0;
            document.getElementById('headerMonthlyAverage').textContent = Math.round(monthlyAverage) + '%';
        }

        function updateDashboard() {
            // Update main stats
            document.getElementById('dashTotalTeachers').textContent = teachers.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = attendanceData.filter(record => record.date === today);
            
            // Reasons that are counted as PRESENT (not deducted from percentage)
            const countAsPresent = [
                'BEKERJA_DARI_RUMAH',
                'BENGKEL', 
                'BERTUGAS_KOKURIKULUM',
                'COVID19',
                'KURSUS',
                'MESYUARAT',
                'PENGAWAS_PEPERIKSAAN',
                'PROSES_PEMULIHAN_JPN',
                'PROSES_PEMULIHAN_PPD',
                'TAKLIMAT',
                'TUGAS_RASMI',
                'CUTI_TANPA_REKOD'
            ];
            
            let todayPercentage = 0;
            if (teachers.length > 0) {
                if (todayData.length === 0) {
                    // No attendance data for today - show 100% (assume all present if no records)
                    todayPercentage = 100;
                } else {
                    // Calculate percentage based on all teachers
                    let presentCount = 0;
                    
                    teachers.forEach(teacher => {
                        const teacherRecord = todayData.find(r => r.teacher === teacher);
                        
                        if (!teacherRecord) {
                            // No record for this teacher - assume present
                            presentCount++;
                        } else if (teacherRecord.status === 'HADIR') {
                            // Marked as present
                            presentCount++;
                        } else if (teacherRecord.status === 'TIDAK_HADIR' && countAsPresent.includes(teacherRecord.reason)) {
                            // Absent but with reason that counts as present
                            presentCount++;
                        }
                        // Other absent reasons reduce the count
                    });
                    
                    todayPercentage = (presentCount / teachers.length) * 100;
                }
            }
            document.getElementById('dashTodayAttendance').textContent = Math.round(todayPercentage) + '%';
            
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthlyData = filterDataByPeriod(attendanceData, 'monthly', currentMonth, currentYear);
            const monthlyPercentages = calculateAttendancePercentages(monthlyData, 'monthly', currentMonth, currentYear);
            const monthlyAverage = monthlyPercentages.length > 0 ? 
                monthlyPercentages.reduce((sum, p) => sum + p.percentage, 0) / monthlyPercentages.length : 0;
            document.getElementById('dashMonthlyAverage').textContent = Math.round(monthlyAverage) + '%';
            

            
            // Update school days - auto calculate if not set
            const schoolDaysKey = `${currentYear}-${currentMonth}`;
            let currentSchoolDays = schoolDays[schoolDaysKey];
            
            if (!currentSchoolDays) {
                // Auto calculate school days for current month
                currentSchoolDays = autoCalculateSchoolDays(currentMonth, currentYear);
                schoolDays[schoolDaysKey] = currentSchoolDays;
                localStorage.setItem('sk_bukit_cermin_school_days', JSON.stringify(schoolDays));
            }
            
            document.getElementById('dashSchoolDays').textContent = currentSchoolDays;
            
            // Update charts
            updateDashboardCharts();
            updateRecentActivity();
            updateTopPerformers();
        }

        function updateDashboardCharts() {
            // Monthly trend chart
            const ctx1 = document.getElementById('dashboardMonthlyChart').getContext('2d');
            if (dashboardMonthlyChart) dashboardMonthlyChart.destroy();
            
            const currentYear = new Date().getFullYear();
            const monthLabels = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];
            const monthlyData = monthLabels.map((_, index) => {
                const monthData = filterDataByPeriod(attendanceData, 'monthly', index + 1, currentYear);
                const percentages = calculateAttendancePercentages(monthData, 'monthly', index + 1, currentYear);
                return percentages.length > 0 ? 
                    percentages.reduce((sum, p) => sum + p.percentage, 0) / percentages.length : 0;
            });

            dashboardMonthlyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Peratus Kehadiran',
                        data: monthlyData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Category chart
            const ctx2 = document.getElementById('dashboardCategoryChart').getContext('2d');
            if (dashboardCategoryChart) dashboardCategoryChart.destroy();
            
            const currentMonth = new Date().getMonth() + 1;
            const monthData = filterDataByPeriod(attendanceData, 'monthly', currentMonth, currentYear);
            const absentData = monthData.filter(record => record.status === 'TIDAK_HADIR' && record.reason);
            
            const reasonCounts = {};
            absentData.forEach(record => {
                const reason = record.reason;
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
            });

            const sortedReasons = Object.entries(reasonCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);

            if (sortedReasons.length > 0) {
                const labels = sortedReasons.map(([reason]) => reason.replace(/_/g, ' '));
                const data = sortedReasons.map(([, count]) => count);
                const colors = [
                    '#ef4444', '#f97316', '#f59e0b', '#eab308', 
                    '#84cc16', '#22c55e', '#10b981', '#14b8a6'
                ];

                dashboardCategoryChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, data.length),
                            borderWidth: 2,
                            borderColor: 'rgba(255, 255, 255, 0.2)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: 'white',
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateRecentActivity() {
            const recentData = attendanceData
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);
            
            const container = document.getElementById('recentActivity');
            
            if (recentData.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-center py-8">Tiada aktiviti terkini</p>';
                return;
            }

            container.innerHTML = recentData.map(record => {
                const date = new Date(record.date).toLocaleDateString('ms-MY');
                const statusIcon = record.status === 'HADIR' ? '‚úÖ' : '‚ùå';
                const statusColor = record.status === 'HADIR' ? 'text-green-400' : 'text-red-400';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">${statusIcon}</span>
                            <div>
                                <div class="text-white font-medium">${record.teacher}</div>
                                <div class="text-blue-200 text-sm">${date}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="${statusColor} font-medium">${record.status}</div>
                            ${record.reason ? `<div class="text-blue-300 text-xs">${record.reason.replace(/_/g, ' ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTopPerformers() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthlyData = filterDataByPeriod(attendanceData, 'monthly', currentMonth, currentYear);
            const percentages = calculateAttendancePercentages(monthlyData, 'monthly', currentMonth, currentYear);
            
            const topPerformers = percentages
                .sort((a, b) => b.percentage - a.percentage)
                .slice(0, 5);
            
            const container = document.getElementById('topPerformers');
            
            if (topPerformers.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-center py-8">Tiada data prestasi</p>';
                return;
            }

            container.innerHTML = topPerformers.map((teacher, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                const colorClass = teacher.percentage >= 90 ? 'percentage-excellent' :
                                 teacher.percentage >= 70 ? 'percentage-good' :
                                 teacher.percentage >= 50 ? 'percentage-warning' : 'percentage-danger';
                
                return `
                    <div class="flex items-center justify-between p-3 ${colorClass} rounded-lg text-white">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">${medal}</span>
                            <div>
                                <div class="font-medium">${teacher.teacher}</div>
                                <div class="text-sm opacity-90">${teacher.present}/${teacher.total} hari</div>
                            </div>
                        </div>
                        <div class="text-xl font-bold">${Math.round(teacher.percentage)}%</div>
                    </div>
                `;
            }).join('');
        }

        // Teacher management
        function updateTeachersList() {
            document.getElementById('totalTeachersCount').textContent = teachers.length;
            document.getElementById('activeTeachersCount').textContent = teachers.length;
            
            // Calculate average attendance rate
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthlyData = filterDataByPeriod(attendanceData, 'monthly', currentMonth, currentYear);
            const percentages = calculateAttendancePercentages(monthlyData, 'monthly', currentMonth, currentYear);
            const averageRate = percentages.length > 0 ? 
                percentages.reduce((sum, p) => sum + p.percentage, 0) / percentages.length : 0;
            document.getElementById('averageAttendanceRate').textContent = Math.round(averageRate) + '%';
            
            // Update school days in admin section
            const schoolDaysKey = `${currentYear}-${currentMonth}`;
            const currentSchoolDays = schoolDays[schoolDaysKey] || 0;
            document.getElementById('adminSchoolDays').textContent = currentSchoolDays;
            
            const container = document.getElementById('teachersList');
            const searchTerm = document.getElementById('searchTeacher')?.value.toLowerCase() || '';
            
            if (teachers.length === 0) {
                container.innerHTML = '<p class="text-blue-300 text-sm italic text-center py-8">Tiada guru didaftarkan</p>';
                return;
            }

            // Filter teachers based on search
            const filteredTeachers = teachers.filter(teacher => {
                return teacher.toLowerCase().includes(searchTerm);
            });

            if (filteredTeachers.length === 0) {
                container.innerHTML = '<p class="text-blue-300 text-sm italic text-center py-8">Tiada guru ditemui</p>';
                return;
            }

            container.innerHTML = filteredTeachers.map(teacher => {
                const index = teachers.indexOf(teacher);
                const details = teachersDetails[index] || {};
                
                // Get attendance percentage for this teacher
                const teacherPercentage = percentages.find(p => p.teacher === teacher);
                const attendanceRate = teacherPercentage ? Math.round(teacherPercentage.percentage) : 0;
                const attendanceColor = attendanceRate >= 90 ? 'text-green-400' :
                                      attendanceRate >= 70 ? 'text-blue-400' :
                                      attendanceRate >= 50 ? 'text-yellow-400' : 'text-red-400';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg mb-3 hover:bg-white/10 transition-all duration-300">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium text-lg">${teacher}</h5>
                                <div class="flex items-center space-x-2">
                                    <span class="${attendanceColor} font-bold">${attendanceRate}%</span>
                                    <button onclick="editTeacher(${index})" class="text-blue-400 hover:text-blue-300 transition-colors duration-200" title="Edit">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="removeTeacher(${index})" class="text-red-400 hover:text-red-300 transition-colors duration-200" title="Buang">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            

                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTeachersDropdown() {
            const select = document.getElementById('selectedTeacher');
            if (!select) {
                console.log('Dropdown element not found');
                return;
            }
            
            // Clear existing options
            select.innerHTML = '<option value="">-- Pilih Guru --</option>';
            
            // Add teachers to dropdown
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                select.appendChild(option);
            });
            
            console.log('Dropdown updated with', teachers.length, 'teachers');
        }

        function addTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            
            if (!name) {
                showMessage('error', 'Sila masukkan nama guru.');
                return;
            }

            if (teachers.includes(name)) {
                showMessage('error', 'Guru ini sudah didaftarkan.');
                return;
            }

            teachers.push(name);
            teachersDetails.push({
                dateAdded: new Date().toISOString()
            });
            
            localStorage.setItem('sk_bukit_cermin_teachers', JSON.stringify(teachers));
            localStorage.setItem('sk_bukit_cermin_teachers_details', JSON.stringify(teachersDetails));
            
            updateAllData();
            updateTeachersDropdown(); // Ensure dropdown is updated
            clearTeacherForm();
            
            showMessage('success', `Guru "${name}" telah berjaya ditambah.`);
        }

        function clearTeacherForm() {
            document.getElementById('teacherForm').reset();
        }

        function editTeacher(index) {
            const teacher = teachers[index];
            
            // Fill form with existing data
            document.getElementById('teacherName').value = teacher;
            
            // Change button to update mode
            const submitBtn = document.getElementById('addTeacherBtn');
            submitBtn.textContent = '‚úèÔ∏è Kemaskini Guru';
            submitBtn.onclick = () => updateTeacher(index);
            
            // Scroll to form
            document.querySelector('#teacherForm').scrollIntoView({ behavior: 'smooth' });
            
            showMessage('info', `Mengedit maklumat guru "${teacher}".`);
        }

        function updateTeacher(index) {
            const name = document.getElementById('teacherName').value.trim();
            
            if (!name) {
                showMessage('error', 'Sila masukkan nama guru.');
                return;
            }

            // Check if name already exists (excluding current teacher)
            if (teachers.includes(name) && teachers[index] !== name) {
                showMessage('error', 'Nama guru ini sudah didaftarkan.');
                return;
            }

            const oldName = teachers[index];
            
            // Update teacher data
            teachers[index] = name;
            teachersDetails[index] = {
                ...teachersDetails[index],
                dateUpdated: new Date().toISOString()
            };
            
            // Update attendance records if name changed
            if (oldName !== name) {
                attendanceData.forEach(record => {
                    if (record.teacher === oldName) {
                        record.teacher = name;
                    }
                });
                localStorage.setItem('sk_bukit_cermin_attendance', JSON.stringify(attendanceData));
            }
            
            localStorage.setItem('sk_bukit_cermin_teachers', JSON.stringify(teachers));
            localStorage.setItem('sk_bukit_cermin_teachers_details', JSON.stringify(teachersDetails));
            
            updateAllData();
            resetTeacherForm();
            
            showMessage('success', `Maklumat guru "${name}" telah dikemaskini.`);
        }

        function resetTeacherForm() {
            clearTeacherForm();
            const submitBtn = document.getElementById('addTeacherBtn');
            submitBtn.textContent = '‚ûï Tambah Guru';
            submitBtn.onclick = null;
        }

        function exportTeachers() {
            if (teachers.length === 0) {
                showMessage('error', 'Tiada data guru untuk dieksport.');
                return;
            }

            let csvContent = 'Nama,Tarikh Ditambah\n';
            
            teachers.forEach((teacher, index) => {
                const details = teachersDetails[index] || {};
                const dateAdded = details.dateAdded ? new Date(details.dateAdded).toLocaleDateString('ms-MY') : 'Tidak diketahui';
                
                csvContent += `"${teacher}","${dateAdded}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `senarai_guru_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('success', 'Senarai guru telah dieksport.');
        }

        function removeTeacher(index) {
            const teacherName = teachers[index];
            
            // Create custom confirmation modal instead of browser confirm
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="glass-card rounded-2xl p-6 max-w-md mx-4">
                    <h3 class="text-xl font-bold text-white mb-4">Pengesahan Pembuangan</h3>
                    <p class="text-blue-200 mb-6">Adakah anda pasti ingin membuang guru "${teacherName}"? Semua data kehadiran akan turut dibuang.</p>
                    <div class="flex space-x-4">
                        <button id="confirmDelete" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3 px-4 rounded-lg font-medium hover:from-red-600 hover:to-red-700 transition-all duration-300">
                            Ya, Buang
                        </button>
                        <button id="cancelDelete" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-4 rounded-lg font-medium hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            document.getElementById('confirmDelete').addEventListener('click', () => {
                teachers.splice(index, 1);
                teachersDetails.splice(index, 1);
                localStorage.setItem('sk_bukit_cermin_teachers', JSON.stringify(teachers));
                localStorage.setItem('sk_bukit_cermin_teachers_details', JSON.stringify(teachersDetails));
                
                attendanceData = attendanceData.filter(record => record.teacher !== teacherName);
                localStorage.setItem('sk_bukit_cermin_attendance', JSON.stringify(attendanceData));
                
                updateAllData();
                showMessage('success', `Guru "${teacherName}" dan semua data kehadiran telah dibuang.`);
                document.body.removeChild(confirmModal);
            });
            
            document.getElementById('cancelDelete').addEventListener('click', () => {
                document.body.removeChild(confirmModal);
            });
        }

        // Attendance management
        function updateTodayAttendanceOverview() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = attendanceData.filter(record => record.date === today);
            const container = document.getElementById('todayAttendanceOverview');
            
            if (todayData.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-center py-8 md:col-span-2 lg:col-span-3">Tiada data kehadiran hari ini</p>';
                return;
            }

            container.innerHTML = todayData.map(record => {
                const statusColor = record.status === 'HADIR' ? 'percentage-excellent' : 'percentage-danger';
                const statusIcon = record.status === 'HADIR' ? '‚úÖ' : '‚ùå';
                
                return `
                    <div class="${statusColor} rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">${record.teacher}</span>
                            <span class="text-xl">${statusIcon}</span>
                        </div>
                        <div class="text-sm opacity-90">${record.status}</div>
                        ${record.reason ? `<div class="text-xs opacity-75 mt-1">${record.reason.replace(/_/g, ' ')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function saveAttendance(data) {
            attendanceData.push(data);
            localStorage.setItem('sk_bukit_cermin_attendance', JSON.stringify(attendanceData));
            
            // Always try to sync to Google Sheets if URL is provided
            if (googleSheetUrl) {
                updateSyncStatus('Menghantar data...', 'text-yellow-400');
                
                try {
                    const formData = new FormData();
                    Object.keys(data).forEach(key => {
                        formData.append(key, data[key]);
                    });

                    // Use no-cors mode for better compatibility
                    const response = await fetch(googleSheetUrl, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });

                    // Since we can't check response in no-cors mode, assume success
                    showMessage('success', 'Data kehadiran telah disimpan ke cloud dan tempatan!');
                    updateConnectionStatus(true);
                    updateSyncStatus('Berjaya dihantar', 'text-green-400');
                } catch (error) {
                    console.log('Cloud sync error:', error);
                    showMessage('warning', 'Data disimpan tempatan. Ralat sync cloud: ' + error.message);
                    updateConnectionStatus(false);
                    updateSyncStatus('Gagal dihantar: ' + error.message, 'text-red-400');
                }
            } else {
                showMessage('success', 'Data kehadiran telah disimpan secara tempatan.');
                updateSyncStatus('Tiada URL Google Sheets', 'text-gray-400');
            }
            
            updateAllData();
        }

        function updateSyncStatus(status, colorClass) {
            const timeElement = document.getElementById('lastSyncTime');
            const resultElement = document.getElementById('lastSyncResult');
            
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleString('ms-MY');
            }
            
            if (resultElement) {
                resultElement.textContent = status;
                resultElement.className = colorClass;
            }
        }

        // Helper functions
        function filterDataByPeriod(data, viewType, month, year) {
            return data.filter(record => {
                const recordDate = new Date(record.date);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1;
                
                if (viewType === 'yearly') {
                    return recordYear === year;
                } else if (viewType === 'monthly') {
                    return recordYear === year && recordMonth === month;
                } else {
                    const today = new Date();
                    return recordDate.toDateString() === today.toDateString();
                }
            });
        }

        function calculateAttendancePercentages(data, viewType, month, year) {
            const results = [];
            
            // Reasons that are counted as PRESENT (not deducted from percentage)
            const countAsPresent = [
                'BEKERJA_DARI_RUMAH',
                'BENGKEL', 
                'BERTUGAS_KOKURIKULUM',
                'COVID19',
                'KURSUS',
                'MESYUARAT',
                'PENGAWAS_PEPERIKSAAN',
                'PROSES_PEMULIHAN_JPN',
                'PROSES_PEMULIHAN_PPD',
                'TAKLIMAT',
                'TUGAS_RASMI',
                'CUTI_TANPA_REKOD'
            ];
            
            teachers.forEach(teacher => {
                const teacherData = data.filter(record => record.teacher === teacher);
                
                if (teacherData.length === 0) {
                    results.push({
                        teacher: teacher,
                        present: 0,
                        total: 0,
                        percentage: 100 // Start with 100% if no records
                    });
                    return;
                }

                let presentCount = 0;
                let totalCount = 0;

                teacherData.forEach(record => {
                    totalCount++;
                    
                    if (record.status === 'HADIR') {
                        presentCount++;
                    } else if (record.status === 'TIDAK_HADIR' && countAsPresent.includes(record.reason)) {
                        // These reasons are counted as present
                        presentCount++;
                    }
                    // Other absent reasons are counted as absent and affect percentage
                });

                const percentage = totalCount > 0 ? (presentCount / totalCount) * 100 : 100;
                
                results.push({
                    teacher: teacher,
                    present: presentCount,
                    total: totalCount,
                    percentage: percentage
                });
            });

            return results;
        }

        // Event listeners setup
        function setupEventListeners() {
            // Header navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    switchSection(section);
                });
            });

            // Teacher management
            document.getElementById('teacherForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addTeacher();
            });
            
            document.getElementById('clearFormBtn').addEventListener('click', () => {
                resetTeacherForm();
                showMessage('info', 'Form telah dikosongkan.');
            });
            
            document.getElementById('searchTeacher').addEventListener('input', () => {
                updateTeachersList();
            });
            
            document.getElementById('exportTeachersBtn').addEventListener('click', exportTeachers);

            // Connection
            document.getElementById('connectBtn').addEventListener('click', async () => {
                const url = document.getElementById('googleSheetUrl').value.trim();
                
                if (!url) {
                    showMessage('error', 'Sila masukkan URL Google Apps Script.');
                    return;
                }

                // Validate URL format
                if (!url.includes('script.google.com') || !url.includes('/macros/s/')) {
                    showMessage('error', 'URL tidak sah. Pastikan URL adalah dari Google Apps Script.');
                    return;
                }

                googleSheetUrl = url;
                localStorage.setItem('sk_bukit_cermin_sheet_url', url);
                
                // Set as connected since we can't reliably test due to CORS
                updateConnectionStatus(true);
                showMessage('success', 'URL Google Sheets telah disimpan! Sistem akan cuba sync data secara automatik.');
            });

            // Test connection button
            document.getElementById('testConnectionBtn').addEventListener('click', async () => {
                const url = document.getElementById('googleSheetUrl').value.trim();
                
                if (!url) {
                    showMessage('error', 'Sila masukkan URL Google Apps Script terlebih dahulu.');
                    return;
                }

                showMessage('info', 'Menguji sambungan...');
                
                try {
                    // Test with a simple POST request to simulate real data sending
                    const testData = new FormData();
                    testData.append('teacher', 'TEST_CONNECTION');
                    testData.append('date', new Date().toISOString().split('T')[0]);
                    testData.append('status', 'TEST');
                    testData.append('reason', '');
                    testData.append('timestamp', new Date().toISOString());
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        body: testData,
                        mode: 'no-cors'
                    });
                    
                    // Since no-cors doesn't allow us to read response, assume success if no error thrown
                    updateConnectionStatus(true);
                    showMessage('success', 'Sambungan berjaya! Google Sheets boleh diakses.');
                } catch (error) {
                    updateConnectionStatus(false);
                    showMessage('error', `Ralat sambungan: ${error.message}`);
                }
            });

            // Attendance form
            document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const teacher = document.getElementById('selectedTeacher').value;
                const date = document.getElementById('attendanceDate').value;
                const reason = document.getElementById('absentReason').value;

                if (!teacher || !date) {
                    showMessage('error', 'Sila lengkapkan semua maklumat yang diperlukan.');
                    return;
                }

                // Reasons that count as present
                const countAsPresent = [
                    'BEKERJA_DARI_RUMAH',
                    'BENGKEL', 
                    'BERTUGAS_KOKURIKULUM',
                    'COVID19',
                    'KURSUS',
                    'MESYUARAT',
                    'PENGAWAS_PEPERIKSAAN',
                    'PROSES_PEMULIHAN_JPN',
                    'PROSES_PEMULIHAN_PPD',
                    'TAKLIMAT',
                    'TUGAS_RASMI',
                    'CUTI_TANPA_REKOD'
                ];

                // Determine status - if no reason selected, it's HADIR
                // If reason is selected but it's in countAsPresent list, still mark as TIDAK_HADIR but will be counted as present in calculations
                const status = reason ? 'TIDAK_HADIR' : 'HADIR';

                const attendanceRecord = {
                    teacher: teacher,
                    date: date,
                    status: status,
                    reason: reason || '',
                    timestamp: new Date().toISOString()
                };

                await saveAttendance(attendanceRecord);
                
                document.getElementById('attendanceForm').reset();
                setTodayDate();
                updateTeachersDropdown(); // Ensure dropdown is refreshed
            });



            // Report generation
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                generateReport();
            });

            // School days management
            document.getElementById('schoolDaysForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveSchoolDays();
            });
            
            // Auto update school days when month/year changes
            document.getElementById('schoolDaysMonth').addEventListener('change', updateSchoolDaysInput);
            document.getElementById('schoolDaysYear').addEventListener('change', updateSchoolDaysInput);
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            
            const filteredData = filterDataByPeriod(attendanceData, reportType, month, year);
            const percentages = calculateAttendancePercentages(filteredData, reportType, month, year);
            
            // Update individual performance report
            const container = document.getElementById('individualPerformanceReport');
            
            if (percentages.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-center py-8">Tiada data untuk tempoh yang dipilih</p>';
                return;
            }

            // Reasons that are counted as PRESENT (not deducted from percentage)
            const countAsPresent = [
                'BEKERJA_DARI_RUMAH',
                'BENGKEL', 
                'BERTUGAS_KOKURIKULUM',
                'COVID19',
                'KURSUS',
                'MESYUARAT',
                'PENGAWAS_PEPERIKSAAN',
                'PROSES_PEMULIHAN_JPN',
                'PROSES_PEMULIHAN_PPD',
                'TAKLIMAT',
                'TUGAS_RASMI',
                'CUTI_TANPA_REKOD'
            ];

            percentages.sort((a, b) => b.percentage - a.percentage);

            const monthNames = ['', 'Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 
                              'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            const periodTitle = reportType === 'monthly' ? `${monthNames[month]} ${year}` : 
                               reportType === 'yearly' ? `Tahun ${year}` : 'Tempoh Tersuai';

            container.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-xl font-bold text-white mb-2">Laporan Prestasi Individu - ${periodTitle}</h4>
                    <p class="text-blue-200 text-sm">Klik pada nama guru untuk melihat butiran kehadiran</p>
                </div>
                
                ${percentages.map(teacher => {
                    const colorClass = teacher.percentage >= 90 ? 'percentage-excellent' :
                                     teacher.percentage >= 70 ? 'percentage-good' :
                                     teacher.percentage >= 50 ? 'percentage-warning' : 'percentage-danger';
                    
                    // Get detailed attendance data for this teacher
                    const teacherData = filteredData.filter(record => record.teacher === teacher.teacher);
                    const absentData = teacherData.filter(record => record.status === 'TIDAK_HADIR');
                    
                    // Calculate absence breakdown by reason
                    const reasonBreakdown = {};
                    absentData.forEach(record => {
                        if (record.reason) {
                            const reasonKey = record.reason;
                            if (!reasonBreakdown[reasonKey]) {
                                reasonBreakdown[reasonKey] = { count: 0, dates: [] };
                            }
                            reasonBreakdown[reasonKey].count++;
                            reasonBreakdown[reasonKey].dates.push(record.date);
                        }
                    });

                    // Calculate total school days for percentage calculation
                    const schoolDaysKey = `${year}-${month}`;
                    const totalSchoolDays = schoolDays[schoolDaysKey] || autoCalculateSchoolDays(month, year);
                    
                    return `
                        <div class="mb-6 glass-card rounded-xl overflow-hidden">
                            <!-- Teacher Summary Header -->
                            <div class="cursor-pointer ${colorClass} p-4 text-white" onclick="toggleTeacherDetails('${teacher.teacher.replace(/'/g, "\\'")}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-xl">${teacher.teacher}</div>
                                        <div class="text-sm opacity-90">
                                            ${teacher.present} hadir daripada ${teacher.total} rekod | 
                                            ${Math.round(teacher.percentage)}% kehadiran
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-right">
                                            <div class="text-3xl font-bold">${Math.round(teacher.percentage)}%</div>
                                            <div class="text-xs opacity-90">
                                                ${teacher.percentage >= 90 ? 'Cemerlang' :
                                                  teacher.percentage >= 70 ? 'Baik' :
                                                  teacher.percentage >= 50 ? 'Sederhana' : 'Perlu Perhatian'}
                                            </div>
                                        </div>
                                        <span class="text-2xl" id="arrow-${teacher.teacher.replace(/\s+/g, '_')}">‚ñº</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Breakdown (Hidden by default) -->
                            <div id="details-${teacher.teacher.replace(/\s+/g, '_')}" class="hidden bg-white/5 p-6">
                                
                                <!-- Absence Summary Table -->
                                ${Object.keys(reasonBreakdown).length > 0 ? `
                                    <div class="mb-6">
                                        <h5 class="text-white font-medium mb-3 flex items-center">
                                            <span class="mr-2">üìä</span> Ringkasan Ketidakhadiran
                                        </h5>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr class="bg-white/10">
                                                        <th class="text-left p-3 text-blue-200 font-medium">Sebab</th>
                                                        <th class="text-center p-3 text-blue-200 font-medium">Bilangan Hari</th>
                                                        <th class="text-center p-3 text-blue-200 font-medium">Peratus</th>
                                                        <th class="text-center p-3 text-blue-200 font-medium">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${Object.entries(reasonBreakdown).map(([reason, data]) => {
                                                        const percentage = ((data.count / totalSchoolDays) * 100).toFixed(1);
                                                        const isExcused = countAsPresent.includes(reason);
                                                        const statusColor = isExcused ? 'text-green-400' : 'text-red-400';
                                                        const statusText = isExcused ? 'Excused' : 'Counted';
                                                        
                                                        return `
                                                            <tr class="border-b border-white/10 hover:bg-white/5">
                                                                <td class="p-3 text-white">${reason.replace(/_/g, ' ')}</td>
                                                                <td class="p-3 text-center text-white font-medium">${data.count}</td>
                                                                <td class="p-3 text-center text-white font-medium">${percentage}%</td>
                                                                <td class="p-3 text-center ${statusColor} font-medium">${statusText}</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Detailed Attendance Records -->
                                <div>
                                    <h5 class="text-white font-medium mb-3 flex items-center">
                                        <span class="mr-2">üìÖ</span> Rekod Kehadiran Terperinci
                                    </h5>
                                    
                                    ${teacherData.length > 0 ? `
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr class="bg-white/10">
                                                        <th class="text-left p-3 text-blue-200 font-medium">Tarikh</th>
                                                        <th class="text-center p-3 text-blue-200 font-medium">Status</th>
                                                        <th class="text-left p-3 text-blue-200 font-medium">Sebab</th>
                                                        <th class="text-center p-3 text-blue-200 font-medium">Kesan Peratus</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${teacherData.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => {
                                                        const date = new Date(record.date).toLocaleDateString('ms-MY');
                                                        const statusIcon = record.status === 'HADIR' ? '‚úÖ' : '‚ùå';
                                                        const statusColor = record.status === 'HADIR' ? 'text-green-400' : 'text-red-400';
                                                        
                                                        let impactText = 'Tiada kesan';
                                                        let impactColor = 'text-gray-400';
                                                        
                                                        if (record.status === 'TIDAK_HADIR' && record.reason) {
                                                            if (countAsPresent.includes(record.reason)) {
                                                                impactText = 'Excused';
                                                                impactColor = 'text-green-400';
                                                            } else {
                                                                impactText = 'Counted';
                                                                impactColor = 'text-red-400';
                                                            }
                                                        }
                                                        
                                                        return `
                                                            <tr class="border-b border-white/10 hover:bg-white/5">
                                                                <td class="p-3 text-white">${date}</td>
                                                                <td class="p-3 text-center">
                                                                    <span class="${statusColor}">${statusIcon} ${record.status}</span>
                                                                </td>
                                                                <td class="p-3 text-blue-200">
                                                                    ${record.reason ? record.reason.replace(/_/g, ' ') : '-'}
                                                                </td>
                                                                <td class="p-3 text-center ${impactColor} font-medium">${impactText}</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : `
                                        <p class="text-blue-300 text-center py-4 italic">Tiada rekod kehadiran untuk tempoh ini</p>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            showMessage('success', 'Laporan terperinci telah berjaya dijana!');
        }

        // Function to toggle teacher details
        function toggleTeacherDetails(teacherName) {
            const detailsId = 'details-' + teacherName.replace(/\s+/g, '_');
            const arrowId = 'arrow-' + teacherName.replace(/\s+/g, '_');
            const detailsElement = document.getElementById(detailsId);
            const arrowElement = document.getElementById(arrowId);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                arrowElement.textContent = '‚ñ≤';
            } else {
                detailsElement.classList.add('hidden');
                arrowElement.textContent = '‚ñº';
            }
        }

        // Make functions globally accessible
        window.removeTeacher = removeTeacher;
        window.editTeacher = editTeacher;
        window.toggleTeacherDetails = toggleTeacherDetails;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9900599e11c54a9b',t:'MTc2MDcwOTkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
